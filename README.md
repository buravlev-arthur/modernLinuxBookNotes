# modernLinuxBookNotes

Important notes from "Learning modern Linux" (Hausenblas M. - 2022).

### Глава 1. Введение

`cat /proc/version` - версия Linux
`cat /proc/cpuinfo | grep "model name"` - информация о ядрах ЦП
`cat /proc/$$/status | head -n6` - первые шесть строк статуса текущего процесса (переменная $$ - текущий процесс)

### Глава 2. Ядро Linux

#### Процессор

`lscpu` - информация о процессоре
`uname -m` - архитектура процессора
`cat /proc/cpuinfo` - вся информация о всех CPU

##### Управление процессами в Linux

- Сессии (SID)
- Группы процессов (PGID)
- Процесс (адресное пространство, потоки, сокеты и т.п. (PID))
- Потоки (TID) / Мультипотоки (TGID) - в Linux представляют из себя процессы, которые раздают процессам ресурсы
- Задачи (структура task_struct определена в sched.h - базовая реализация Потоков и Процессов)

`ls /proc/self` - данные текущего процесса
`ps -j` - данные процессов
`ls /proc/<PID>/task/<TID>` - увидеть данные и ресурсы задачи процесса

#### Память RAM

Виртуальная память -> Процесс [таблица страниц памяти процесса] <- Физическая память (RAM)
TLB кэширует физические адреса страниц памяти процесса для ускорения работы процессора.
Стандартный размер страницы памяти - 4 KB. В сорвеменных Linux используются более крупные страницы памяти.

`grep MemTotal /proc/meminfo` - объяем физической памяти
`grep VmallocTotal /proc/meminfo` - объём виртуальной памяти
`grep Hugepagesize /proc/meminfo` - размер страницы памяти

#### Сеть

Linux-стек:

- Сокеты (абстракции соединений)
- TCP/UDP
- IP

`ip link` - сетевые интерфейсы
`ip route` - сетевые маршруты

#### Файловая система

Множество видов: ext4, ntfs, btrfs.
VFS - виртуальные файловые сестемы используется для одновременной работы со множеством типов и экземляров файловых систем.

#### Устройства

Драйверы устройств (физических и псевдо-устройств) хранятся в ядре статически или в виде модулей.

`ls /sys/devices` - список устройств

#### Системные вызовы

Несколько сотен. Вызываются напрямую, либо через "C standart library" (реализации: glibc, musl).
Системные вызовы - это программные прерывания, вызывающие исключения, которые передают управление обработчику исключения.
В syscall.h хранится таблица системных вызовов (переменная sys_call_table), хранящая последовательность системных вызовов и их обработчиков.
system_call() - функция мультиплексор, сохранающая контекст ап.обеспечения в стэк, делающая проверки и вызывающая в конце обработчик исключения из sys_call_table.

`strace ls` - список системных вызовов, вызываемых командой ls
`strace -c curl -s https://google.ru > /dev/null` - вывод затрат времени на системные вызовы (/dev/null - направить вывод вникуда)

Список системных вызовов: https://filippo.io/linux-syscall-table/

#### Расширения ядра

`uname -srm` - имя, релиз ядра и архитектура машины
`find /lib/modules/$(uname -r) -name "*.ko*" -type f` - поиск доступных модулей для текущего ядра
`lsmod` или `cat /proc/modules` - список загруженных модулей
`modprobe --show-depends video` - показать зависимости модуля video

##### eBPF (Berkeley Packet Filter)

Начиная с версии Linux-ядра 3.15 расширать его функциональность можно с помощью системного вызова bpf. eBPF реализован как виртуальная машина внутри ядра с набором RISC-инструкций.

### Глава 3. Оболочки и сценарии

`echo $TERM` - название используемого терминала
`infocmp` - конфигурация используемого терминала
`sh` - запуск оболочки (сегодня по-умолчанию bash (Bourne Again Shell), наследница оригинальной Bourne Shell)
`echo $0` - имя используемой оболочки (а вообще имя текущего процесса)

#### Потоки

Оболочка определяет для каждого процесса три файловых дескриптора (FDs):

- stdin (FD 0)
- stdout (FD 1)
- stderr (FD 2)

`cat file.txt 1> output.txt 2> err.txt` - вывести поток stdout из файла file.txt в файл output output.txt а stderr - в err.txt
`cat file.txt &> output.txt` - вывести оба потока stdout и stderr в output.txt
`cat file.txt > /dev/null` - убрать поток stdout
`cat > output.txt` - записывать ввод в файл (Ctrl + D для выхода и сохранения)
`tr < result.txt [A-Z] [a-z]` - команда tr читает поток stdin из файла result.txt и заменяет все заглавные символы на строчные

Специальные символы:
`&` - выполняет команду в фоновом режиме
`/` - переводит запись команды на следующую строку
`|` - передаёт stdout (команды слева) в stdin (команды справа)

Команда убирает статус об ошибке, передают stdout curl'а в stdin wc и записана с переносом строки (/):

```
curl https://example.com 2> /dev/null | \
wc -l
```

#### Переменные

- Переменные окружения (`env`)
- Переменные оболочки (`set`)

`set MY_VAR=42` - создаём переменную оболочки
`set | grep 'MY_VAR'` - выводим переменную со значением
`export MY_GLOBAL_VAR=42` - создаём переменную окружения
`env | grep 'MY_GLOBAL_VAR'` - выводим переменную окружения
`unset $MY_VAR` - удаление переменной
`bash` - создаём новую сессию - дочерний процесс процесса текущей сессии
`exit` - выход из процесса сессии
`echo $?` - статус выхода (exit status). 0 - успешно, 1-255 - ошибка
`echo $PIPESTATUS` - тот же exit status, но для применения в конвеерах
